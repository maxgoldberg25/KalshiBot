name: Daily Trading Run

on:
  schedule:
    # Run at 8:30 AM ET (13:30 UTC during EST, 12:30 UTC during EDT)
    - cron: '30 13 * * 1-5'  # Monday-Friday
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading mode'
        required: true
        default: 'paper'
        type: choice
        options:
          - paper
          - dry_run
          - live

env:
  KALSHI_BOT_KALSHI_API_KEY: ${{ secrets.KALSHI_API_KEY }}
  KALSHI_BOT_SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  KALSHI_BOT_MODE: ${{ github.event.inputs.mode || 'paper' }}

jobs:
  run:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run trading bot
        run: |
          python -m kalshi_bot run --mode ${{ env.KALSHI_BOT_MODE }}
      
      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trading-logs-${{ github.run_id }}
          path: |
            *.log
            kalshi_bot.db
          retention-days: 30

  notify-failure:
    runs-on: ubuntu-latest
    needs: run
    if: failure()
    
    steps:
      - name: Send failure notification
        if: env.KALSHI_BOT_SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ðŸš¨ Kalshi Bot daily run failed! Check GitHub Actions."}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
